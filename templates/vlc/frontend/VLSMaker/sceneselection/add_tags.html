{% load static %}
<div id="separateSlide" class="wrapper">
    
    <div class="guide">
        <span class="guide-title">Separate Words To Add Multiple Cips </span>
        <span class="guide-icon" title="To Select Multiple Clips On This Line, Place Your Cursor Where You Want To Separate The Words, Type '/' To Separate The Words. When Done, Click The Done Button.">?</span>
    </div>

    <div class="tag-box">
        <ul id="list-of-tags" class="list-of-tags">
            <input class="tag-input" id="words" value="" type="text">
        </ul>
        <input id="id" name="id" hidden type="number">
    </div>
    <div id="error-message" class="error-message"></div>
    <div class="details">
        <button id="reset-btn" type="button">Reset</button>
        <button id="done-btn" type="button"></button>
    </div>
</div>

<script>
   const listOfTags = document.getElementById('list-of-tags');
    const input = listOfTags.querySelector('input');
    const resetBtn = document.getElementById('reset-btn');
    const doneBtn = document.getElementById('done-btn');
    let initialValue = input.value;
    const errorMessage = document.getElementById('error-message');
    function createTag(text) {
        const li = document.createElement('li');
        li.textContent = text;
        document.getElementById('no_of_slides').value++

        listOfTags.insertBefore(li, input);
    }

    function updateClipCount() {
        const tags = document.querySelectorAll('.list-of-tags li'); 
        const remainingText = input.value.trim();

        let clipCount = tags.length;  
        if (remainingText) {
            clipCount += 1;  
        }
        
        const doneBtn = document.getElementById('done-btn');
        doneBtn.textContent = `Proceed To Add ${clipCount} Clip${clipCount > 1 ? 's' : ''}`;
    }

    function handleKeyPress(e) {
        const value = input.value;
        let cursorPosition = input.selectionStart;  

        function moveToWordStart(pos) {
            while (pos > 0 && value[pos - 1] === ' ') {
                pos--;  
            }
            while (pos > 0 && value[pos - 1] !== ' ') {
                pos--;  
            }
            return pos;
        }

        function moveToWordEnd(pos) {
            while (pos < value.length && value[pos] === ' ') {
                pos++;  
            }
            while (pos < value.length && value[pos] !== ' ') {
                pos++;  
            }
            return pos;
        }

        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            cursorPosition = moveToWordStart(cursorPosition);
            input.setSelectionRange(cursorPosition, cursorPosition); 
        }
        else if (e.key === 'ArrowRight') {
            e.preventDefault();
            cursorPosition = moveToWordEnd(cursorPosition);
            input.setSelectionRange(cursorPosition, cursorPosition);  
        }
        else if (e.key === '/') {
            const isAtValidPosition =
                cursorPosition === value.length || 
                value[cursorPosition - 1] === ' ' ||  
                (cursorPosition > 0 && value[cursorPosition] === ' '); 

            if (!isAtValidPosition) {
                e.preventDefault(); 
                errorMessage.textContent = 'Wrong Position To Separate Words';
                return;
            }

            e.preventDefault();
            const beforeCursor = value.substring(0, cursorPosition).trim();
            if (beforeCursor) createTag(beforeCursor);
            errorMessage.textContent = '';

            input.value = value.substring(cursorPosition).trim();
            updateClipCount();  
        }
        else if (e.key === 'Enter') {
            const isAtValidPosition =
                cursorPosition === value.length ||
                value[cursorPosition - 1] === ' ' ||  
                (cursorPosition > 0 && value[cursorPosition] === ' ');

            if (!isAtValidPosition) {
                e.preventDefault(); 
                errorMessage.textContent = 'Wrong Position To Separate Words';
                return;
            }

            e.preventDefault();
            const beforeCursor = value.substring(0, cursorPosition).trim();
            const afterCursor = value.substring(cursorPosition).trim();

            if (beforeCursor) createTag(beforeCursor);
            if (afterCursor) createTag(afterCursor);
            errorMessage.textContent = '';

            input.value = ''; 
            updateClipCount();
        }
    }

 
    function preventUnwantedKeys(e) {
        const allowedKeys = [
            'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Enter', '/'
        ];

        
        if (!allowedKeys.includes(e.key)) {
            e.preventDefault();
        }
    }

    function resetTags() {
        
        const tags = listOfTags.querySelectorAll('li');
        tags.forEach(tag => tag.remove());
        input.value = initialValue;
        errorMessage.textContent=''
        doneBtn.textContent='Proceed To add 1 Clip'
        document.getElementById('no_of_slides').value=1


    }

    function convertRemainingToTag() {
        const value = input.value.trim();
        if (value) {
            createTag(value);
            input.value = ''; 

            errorMessage.textContent=''
            document.getElementById('separateSlide').style.display='none'
            // document.getElementById('chooseVideo').style.display='flex'
            let no_of_slides=document.getElementById('no_of_slides').value
            for (let i = start; i <= no_of_slides +1; i++) {
                            addSlide(i);
                        }
                    }
                }

    function addSlide(currentNumber) {

    var table = document.getElementById('leadsTable').getElementsByTagName('tbody')[0];
    var newRow = table.insertRow(-1);
    var slideCell = newRow.insertCell(0);
    
    slideCell.innerText = `Clip ${currentNumber}`;
    newRow.innerHTML += 
        `<td>
          <textarea style="font-size: 19px;" type="text" name="slide_text_${currentNumber}" value="" placeholder="Type Your Sentence Here" class="form-control tab-textarea" aria-describedby="textarea"></textarea>
        </td>
        <td style="background: none;">
           <div class="custum-browse custum-browse-v2 d-flex align-items-center">
             <div class="brws">
               <input class="br-input" type="file" name="slide_file_${currentNumber}"accept="image/*,video/*"  >
                  <a href="#!" class="btn get-start browse-btn">
                 <img src="{% static 'lead-maker/images/upload-icn-black.svg' %}" alt=""> Choose file
               </a>
             </div>
            
           </div>
         </td>
         <td>
                <a href="#!" class="delete-row-btn" onclick="deleteSlide(this)">
                  <img src="{% static 'lead-maker/images/delete-icn.svg' %}" alt="delete" />
                </a>
         </td>`;
 
         const fileInputs = document.querySelectorAll('.br-input');
    
         const noFileTexts = document.querySelectorAll('.btn.get-start.browse-btn');
    
         console.log(fileInputs,noFileTexts);
    fileInputs.forEach((input, index) => {
      input.addEventListener('change', (event) => {
        const fileName = event.target.files.length > 0 ? event.target.files[0].name : 'Choose file';
        noFileTexts[index].lastChild.textContent = fileName; // Update the text to show the selected file name
      });
    });
}

    input.addEventListener('keydown', handleKeyPress);
    input.addEventListener('keydown', preventUnwantedKeys);
    resetBtn.addEventListener('click', resetTags);
    doneBtn.addEventListener('click', convertRemainingToTag);

    input.addEventListener('paste', e => e.preventDefault());
</script>