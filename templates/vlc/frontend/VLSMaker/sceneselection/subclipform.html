<div class="popup-form" id="add-subclip-popup">
    <div class="popup-container">
        <form method="POST" enctype="multipart/form-data" id="add-subclip-form">
            {% csrf_token %}


            <div id="submit-cont">
            </div>
            <div  class="form-group">
                <button type="submit" id="submit-clip" class="submit-btn">Add Clip</button>
            </div>
        </form>
        <button class="close-btn" onclick="closeModal()" id="close-popup-btn">Close</button>
    </div>
</div>

<style>
    .popup-form {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .popup-container {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 450px;
        width: 100%;
        align-items:center;
    }

    .form-group {
        margin-top: 20px;
        /* margin-bottom: 15px; */
        margin-left: 25px;
        margin-right: 25px;

        
    }

    .form-group label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }

    .form-input, .form-textarea, .form-select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-textarea {
        resize: vertical;
    }

    .submit-btn {
        background-color: #864AF9;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
        border-radius: 4px;
    }

    .submit-btn:hover {
        background-color: #864AF9;
        opacity: 0.8;
    }

    .close-btn {
        background-color: #f44336;
        color: white;
        padding: 10px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        margin-top: 10px;
        border-radius: 4px;
        width: 100%;
    }

    .close-btn:hover {
        background-color: #e53935;
    }
</style>

<script>
    
    function fetchVideoClips(selected){
        id = selected.value;
        let video_id=`videoSelect_${clip_id}_${num}`
        saveInput(selected)
        if (id){
            populateVideoCategories(video_id,`/video/get_clip/${id}`)

        }
    }

    async function restoreForm(){
                const inputs = document.querySelectorAll('select');

        for (const input of inputs) {
            const storedValue = sessionStorage.getItem(input.id);
            if (storedValue && input.id.startsWith('selected_topic_')) {
                input.value = storedValue;

                const idParts = input.id.split('_');
                const currentNumber = idParts[idParts.length - 2]; 

                const url = `/video/get_clip/${storedValue}`;
                const targetId = `videoSelect_${clip_id}_${num}`;
               await populateVideoCategories(targetId,url);  

            }
        }
        inputs.forEach(input => {
            const storedValue = sessionStorage.getItem(input.id);
            if (storedValue && input.id.startsWith('videoSelect_')) {
                input.value = storedValue;
            }
        });
    
      };

    function populateVideoCategories(selectElementId, apiUrl) {
        const selectElement = document.getElementById(selectElementId);

        if (!selectElement) {
            console.error(`Select element with ID "${selectElementId}" not found.`);
            return;
        }


        // Fetch categories from the API
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(categories => {
                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat.id;         
                    option.textContent = cat.title; 
                    selectElement.appendChild(option);
                });
            restoreVideoSelectInputs();

            })
            .catch(error => {
                console.error("Failed to fetch video categories:", error);
            });
    }

    document.getElementById('close-popup-btn').addEventListener('click', function() {


    });

function closeModal() {
    document.getElementById('add-subclip-popup').style.display = 'none';

    const formClipID = document.getElementById('clipId').value;
    const ulElement = document.getElementById(`list-of-tags_${formClipID}`);
    const spanElement = document.getElementById(`slide_span_${formClipID}`);
    if (ulElement && ulElement.children.length > 1) {
        const secondToLastLi = ulElement.children[ulElement.children.length - 2]; 
        const secondToLastLiText = secondToLastLi.textContent; 

        const spanText= spanElement.textContent.trim();
        spanElement.textContent= `${secondToLastLiText} ${spanText}`
        console.log("Last <li> text:", secondToLastLiText); 

        ulElement.removeChild(secondToLastLi);
    } else {
        console.log("No <li> items found to remove.");
    }
}
function attachValidation(formId, clipId) {
    const form = document.getElementById(formId);
    if (form) {
        const formClipID = document.getElementById(clipId).value;

        form.addEventListener('submit', function (event) {
            const fileInput = document.getElementById('slide_file');
            const videoSelect = document.querySelector(`#videoSelect_${formClipID}_${num}`);

            if ((!fileInput.value || fileInput.value.trim() === "") &&
                (!videoSelect.value || videoSelect.value.trim() === "")) {
                event.preventDefault();
                alert("Please either upload a video file or select a video clip.");
            }
        });
    }
}

</script>
